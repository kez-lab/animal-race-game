<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”½ì…€ ì»¤í”¼ ê²½ë§ˆ</title>
    <!-- í”½ì…€ ì•„íŠ¸ í°íŠ¸ -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --pixel-font: 'Press Start 2P', cursive;
            --grass-light: #66cc66;
            --grass-dark: #55aa55;
            --dirt-light: #dcb159;
            --dirt-dark: #b89040;
        }

        body {
            font-family: var(--pixel-font);
            background-color: #2c3e50;
            color: white;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* í”½ì…€ ì•„íŠ¸ ìŠ¤íƒ€ì¼ ë²„íŠ¼ */
        .pixel-btn {
            background-color: #ffcc00;
            border: 4px solid #000;
            box-shadow: 4px 4px 0px #000;
            color: #000;
            transition: transform 0.1s;
            image-rendering: pixelated;
        }

        .pixel-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #000;
        }

        .pixel-btn.danger {
            background-color: #ff5555;
        }

        .pixel-btn.success {
            background-color: #55ff55;
        }

        /* í”½ì…€ ì•„íŠ¸ íŒ¨ë„ */
        .pixel-panel {
            background-color: #fff;
            border: 4px solid #000;
            box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.5);
            color: #000;
        }

        /* íŠ¸ë™ ìŠ¤íƒ€ì¼ */
        .track-container {
            background: repeating-linear-gradient(90deg,
                    var(--grass-light),
                    var(--grass-light) 50px,
                    var(--grass-dark) 50px,
                    var(--grass-dark) 100px);
            border: 4px solid #000;
            position: relative;
            overflow: hidden;
            padding-bottom: 20px;
        }

        .finish-line {
            position: absolute;
            right: 40px;
            top: 0;
            bottom: 0;
            width: 20px;
            background: repeating-linear-gradient(0deg,
                    #fff,
                    #fff 10px,
                    #000 10px,
                    #000 20px);
            z-index: 0;
        }

        .lane {
            border-bottom: 2px dashed rgba(0, 0, 0, 0.2);
            position: relative;
            height: 60px;
            display: flex;
            align-items: center;
        }

        /* ë§ ì• ë‹ˆë©”ì´ì…˜ */
        .horse {
            width: 48px;
            height: 48px;
            position: absolute;
            left: 0;
            transition: left 0.1s linear;
            z-index: 10;
        }

        .horse-sprite {
            width: 100%;
            height: 100%;
            animation: gallop 0.4s infinite steps(2);
        }

        @keyframes gallop {
            0% {
                transform: translateY(0) rotate(0deg);
            }

            50% {
                transform: translateY(-3px) rotate(2deg);
            }

            100% {
                transform: translateY(0) rotate(0deg);
            }
        }

        .dust {
            position: absolute;
            bottom: 5px;
            left: -10px;
            width: 10px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.6);
            opacity: 0;
        }

        .dust.active {
            animation: dust-poof 0.5s linear;
        }

        @keyframes dust-poof {
            0% {
                opacity: 0.8;
                transform: scale(1) translate(0, 0);
            }

            100% {
                opacity: 0;
                transform: scale(2) translate(-20px, -10px);
            }
        }

        .pixel-input {
            border: 4px solid #000;
            padding: 10px;
            font-family: var(--pixel-font);
            width: 100%;
            outline: none;
        }

        .hidden {
            display: none !important;
        }

        .hidden {
            display: none !important;
        }

        /* íŠ¸ë™ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .track-item {
            position: absolute;
            bottom: 5px;
            font-size: 20px;
            z-index: 5;
            transition: opacity 0.2s, transform 0.2s;
        }

        .track-item.hit {
            opacity: 0.3;
            transform: scale(0.8);
            filter: grayscale(1);
        }

        /* ê²°ê³¼ í™”ë©´ ì• ë‹ˆë©”ì´ì…˜ */
        .loser-title {
            animation: pulse 1s infinite alternate;
        }

        /* ì•„ì´í…œ íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
        .boost-effect {
            animation: boost 0.5s infinite;
        }

        @keyframes boost {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.2);
                filter: brightness(1.5);
            }

            100% {
                transform: scale(1);
                filter: brightness(1);
            }
        }

        .stun-effect {
            animation: stun 0.2s infinite;
            filter: grayscale(100%);
        }

        @keyframes stun {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(10deg);
            }

            75% {
                transform: rotate(-10deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .pixel-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .pixel-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            background: #fff;
            margin-right: 10px;
            position: relative;
        }

        .pixel-checkbox:checked {
            background: #66cc66;
        }

        .pixel-checkbox:checked::after {
            content: 'v';
            position: absolute;
            top: -2px;
            left: 4px;
            color: #000;
            font-weight: bold;
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(1.05);
            }
        }

        /* ë­í‚¹ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .rank-item {
            border-bottom: 2px solid #eee;
            padding: 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .rank-item:last-child {
            border-bottom: none;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            text-align: center;
            margin-right: 10px;
        }

        /* ì‘ì€ í”½ì…€ ë²„íŠ¼ (X ë²„íŠ¼ìš©) */
        .pixel-btn-sm {
            background-color: #eee;
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .pixel-btn-sm:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px #000;
        }

        /* ê¸´ì¥ê° í–¥ìƒ íš¨ê³¼ */

        /* í™”ë©´ í”ë“¤ë¦¼ (ëŒí’ ì´ë²¤íŠ¸) */
        @keyframes screen-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10% {
                transform: translateX(-10px) rotate(-1deg);
            }

            20% {
                transform: translateX(10px) rotate(1deg);
            }

            30% {
                transform: translateX(-8px) rotate(-0.5deg);
            }

            40% {
                transform: translateX(8px) rotate(0.5deg);
            }

            50% {
                transform: translateX(-5px);
            }

            60% {
                transform: translateX(5px);
            }

            70% {
                transform: translateX(-3px);
            }

            80% {
                transform: translateX(3px);
            }

            90% {
                transform: translateX(-1px);
            }
        }

        .shake {
            animation: screen-shake 0.8s ease-out;
        }

        /* ìŠ¬ë¡œìš°ëª¨ì…˜ íš¨ê³¼ */
        .slowmo .horse {
            transition: left 0.3s linear !important;
        }

        .slowmo .horse-sprite {
            animation-duration: 0.8s !important;
        }

        /* ì‚¬ì§„ íŒì • íŒì—… */
        .photo-finish-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b6b, #ffd93d);
            padding: 20px 40px;
            border: 6px solid #000;
            box-shadow: 8px 8px 0px #000;
            z-index: 100;
            animation: photo-flash 0.5s ease-out;
        }

        @keyframes photo-flash {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* ëŒí’ ì´ë²¤íŠ¸ ì˜¤ë²„ë ˆì´ */
        .wind-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(200, 230, 255, 0.3) 20%,
                    rgba(200, 230, 255, 0.5) 50%,
                    rgba(200, 230, 255, 0.3) 80%,
                    transparent 100%);
            pointer-events: none;
            z-index: 50;
            animation: wind-blow 0.8s ease-out forwards;
        }

        @keyframes wind-blow {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ê²°ìŠ¹ì„  ë¹›ë‚˜ëŠ” íš¨ê³¼ */
        .finish-glow {
            animation: glow-pulse 0.3s infinite alternate;
        }

        @keyframes glow-pulse {
            from {
                box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            }

            to {
                box-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700, 0 0 60px #ffd700;
            }
        }

        /* ê¸´ì¥ê° ìƒíƒœ í‘œì‹œ */
        .tension-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border: 3px solid;
            font-size: 12px;
            z-index: 30;
        }

        .tension-low {
            border-color: #4CAF50;
        }

        .tension-medium {
            border-color: #FFC107;
        }

        .tension-high {
            border-color: #f44336;
            animation: pulse 0.5s infinite;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- 1. ì„¤ì • í™”ë©´ -->
    <div id="setup-screen" class="pixel-panel p-8 max-w-md w-full text-center">
        <h1 class="text-2xl mb-8 leading-relaxed text-blue-800">â˜• COFFEE<br>RACE</h1>
        <div class="mb-6">
            <label class="block mb-4 text-sm">ì°¸ê°€ ì¸ì› (2-8ëª…)</label>
            <div class="flex justify-center items-center gap-4">
                <button onclick="changeCount(-1)" class="pixel-btn w-10 h-10 text-xl">-</button>
                <span id="player-count-display" class="text-2xl w-10">4</span>
                <button onclick="changeCount(1)" class="pixel-btn w-10 h-10 text-xl">+</button>
            </div>
        </div>

        <div class="mb-6 bg-blue-100 p-2 border-2 border-blue-300 rounded">
            <label class="pixel-checkbox-label justify-center">
                <input type="checkbox" id="item-mode-toggle" class="pixel-checkbox">
                <span>ğŸ² ì•„ì´í…œ ëª¨ë“œ (ë°”ë‚˜ë‚˜/ë¶€ìŠ¤í„°)</span>
            </label>
        </div>
        <button onclick="goToNaming()" class="pixel-btn w-full py-4 text-lg mt-4">NEXT ></button>
    </div>

    <!-- 2. ì´ë¦„ ì…ë ¥ í™”ë©´ -->
    <div id="naming-screen" class="pixel-panel p-6 max-w-md w-full hidden">
        <h2 class="text-xl mb-6 text-center text-blue-800">ì„ ìˆ˜ ì…ì¥</h2>
        <div id="name-inputs" class="space-y-4 mb-6 max-h-[60vh] overflow-y-auto pb-4">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ìƒì„±ë¨ -->
        </div>
        <button onclick="startRace()" class="pixel-btn success w-full py-4 text-lg">RACE START!</button>
    </div>

    <!-- 3. ê²½ê¸° í™”ë©´ -->
    <div id="race-screen" class="w-full max-w-4xl hidden">
        <div class="pixel-panel p-2 mb-4 bg-yellow-100 flex justify-between items-center sticky top-0 z-20">
            <div class="text-xs md:text-sm text-black blinking" id="game-status">ì¤€ë¹„ ì¤‘...</div>
            <button id="reset-btn" onclick="resetGame()" class="pixel-btn text-xs px-2 py-1 hidden">ì¬ê²½ê¸°</button>
        </div>

        <div id="track" class="track-container rounded-lg shadow-lg mb-4 bg-green-600">
            <div class="finish-line"></div>
            <!-- ë ˆì¼ì´ ì—¬ê¸°ì— ìƒì„±ë¨ -->
        </div>

        <!-- ì¤‘ê³„ì„ -->
        <div class="pixel-panel p-4 bg-black text-green-400 text-xs md:text-sm h-24 overflow-hidden relative">
            <div class="absolute top-2 left-2 text-gray-500 text-[10px]">COMMENTARY</div>
            <div id="commentary-box" class="mt-4 leading-loose">
                ì„ ìˆ˜ë“¤ì´ ë¼ì¸ì— ì„°ìŠµë‹ˆë‹¤...<br>
                ê¸´ì¥ë˜ëŠ” ìˆœê°„ì…ë‹ˆë‹¤!
            </div>
        </div>
    </div>

    <!-- 4. ê²°ê³¼ ëª¨ë‹¬ (ìˆ˜ì •ë¨) -->
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="pixel-panel p-6 max-w-lg w-full relative animate-fade-in max-h-[90vh] overflow-y-auto">

            <!-- ê¼´ì°Œ ê°•ì¡° ì„¹ì…˜ -->
            <div class="bg-red-100 p-6 border-4 border-red-500 text-center mb-6 loser-title">
                <div class="text-sm text-red-600 mb-2 font-bold">â˜ ï¸ ì˜¤ëŠ˜ì˜ ì»¤í”¼ ìš”ì • (ê¼´ì°Œ) â˜ ï¸</div>
                <div id="loser-name" class="text-3xl text-red-800 font-bold mb-1">???</div>
                <div id="loser-time" class="text-sm text-red-500">ê¸°ë¡: --.--s</div>
                <div class="text-xs mt-3 text-gray-600 bg-white inline-block px-2 py-1 border border-gray-300">ì˜ ë§ˆì‹œê² ìŠµë‹ˆë‹¤
                    ^^</div>
            </div>

            <!-- ì „ì²´ ë­í‚¹ ë¦¬ìŠ¤íŠ¸ -->
            <h3 class="text-lg mb-4 text-center text-blue-800 border-b-4 border-blue-800 pb-2">ğŸ† ì „ì²´ ìˆœìœ„ ğŸ†</h3>
            <div id="ranking-list" class="text-black text-sm mb-6 max-h-60 overflow-y-auto pr-2">
                <!-- JSë¡œ ë­í‚¹ ì•„ì´í…œ ìƒì„± -->
            </div>

            <button onclick="resetGame()" class="pixel-btn w-full py-4">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>

    <script>
        // --- ê²Œì„ ì„¤ì • ë° ìƒíƒœ ---
        let playerCount = 4;
        let players = [];
        let isRacing = false;
        let isItemMode = false;
        let startTime = 0;
        let commentaryTimer;
        let savedPlayerNames = {};

        // --- ê¸´ì¥ê° í–¥ìƒ ìƒíƒœ ---
        let isSlowMotion = false;
        let windEventTriggered = false;
        let lastLeaderId = null;
        let leadChangeCount = 0;
        let photoFinishCandidates = [];

        const trackLength = 85;

        // --- ì´ˆê¸°í™” ë¡œì§ ---
        function initSettings() {
            // 1. í”Œë ˆì´ì–´ ìˆ˜ ë³µêµ¬
            const savedCount = localStorage.getItem('playerCount');
            if (savedCount) {
                playerCount = parseInt(savedCount);
                document.getElementById('player-count-display').innerText = playerCount;
            }

            // 2. ì•„ì´í…œ ëª¨ë“œ ë³µêµ¬
            const savedItemMode = localStorage.getItem('isItemMode');
            if (savedItemMode !== null) {
                isItemMode = savedItemMode === 'true';
                document.getElementById('item-mode-toggle').checked = isItemMode;
            }

            // 3. ì €ì¥ëœ ì´ë¦„ë“¤ ë³µêµ¬
            const savedNames = localStorage.getItem('playerNames');
            if (savedNames) {
                savedPlayerNames = JSON.parse(savedNames);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', initSettings);

        function saveSettings() {
            localStorage.setItem('playerCount', playerCount);
            localStorage.setItem('isItemMode', document.getElementById('item-mode-toggle').checked);

            // í˜„ì¬ ì…ë ¥ëœ ì´ë¦„ë“¤ ìˆ˜ì§‘í•˜ì—¬ ì €ì¥
            for (let i = 0; i < 8; i++) {
                const input = document.getElementById(`p${i}`);
                if (input) {
                    savedPlayerNames[i] = input.value;
                }
            }
            localStorage.setItem('playerNames', JSON.stringify(savedPlayerNames));
        }

        const colors = [
            '#FF0000', '#0000FF', '#00AA00', '#FFD700',
            '#FF00FF', '#00FFFF', '#FFA500', '#800080'
        ];

        const horseSvg = (color) => `
            <svg viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(2px 2px 0px black);">
                <path d="M4 14h4v2H4zM6 16h2v2H6zM14 14h2v4h-2zM16 16h2v2h-2z" />
                <path d="M2 12h6v2H2zM12 12h6v2h-6z" />
                <path d="M4 8h4v4H4zM10 8h8v4h-8z" />
                <path d="M12 4h6v4h-6z" />
                <path d="M16 2h2v2h-2z" />
                <path d="M18 4h2v2h-2z" />
                <path d="M18 6h-2v2h2z" fill="black" /> <!-- ëˆˆ -->
            </svg>
        `;

        // --- í™”ë©´ ì „í™˜ í•¨ìˆ˜ ---
        function changeCount(delta) {
            playerCount += delta;
            if (playerCount < 2) playerCount = 2;
            if (playerCount > 8) playerCount = 8;
            document.getElementById('player-count-display').innerText = playerCount;
            saveSettings(); // ìˆ˜ ë³€ê²½ ì‹œ ì €ì¥
        }

        function goToNaming() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('naming-screen').classList.remove('hidden');
            generateNameInputs();
        }

        function generateNameInputs() {
            const container = document.getElementById('name-inputs');
            container.innerHTML = '';
            for (let i = 0; i < playerCount; i++) {
                const defaultName = `í”Œë ˆì´ì–´ ${i + 1}`;
                const savedName = savedPlayerNames[i];
                const value = savedName !== undefined ? savedName : defaultName;

                const div = document.createElement('div');
                div.className = 'flex gap-2 items-center w-full';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded border-2 border-black flex-shrink-0" style="background-color: ${colors[i]}"></div>
                    <div class="relative flex-grow flex items-center">
                        <input type="text" id="p${i}" value="${value}" 
                               oninput="saveSettings()"
                               class="pixel-input pr-10" placeholder="ì´ë¦„ ì…ë ¥">
                        <button onclick="clearInput(${i})" class="pixel-btn-sm absolute right-2" title="ì§€ìš°ê¸°">X</button>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        function clearInput(id) {
            const input = document.getElementById(`p${id}`);
            input.value = '';
            saveSettings(); // ì§€ìš°ê¸° ì‹œ ì €ì¥
            input.focus();
        }

        // --- ë ˆì´ìŠ¤ ë¡œì§ ---
        function startRace() {
            // ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            saveSettings(); // ì‹œì‘ ì „ í˜„ì¬ ì´ë¦„ë“¤ ìµœì¢… ì €ì¥
            players = [];
            for (let i = 0; i < playerCount; i++) {
                const name = document.getElementById(`p${i}`).value || `ì„ ìˆ˜ ${i + 1}`;
                players.push({
                    id: i,
                    name: name,
                    color: colors[i],
                    pos: 0,
                    rank: null,
                    finishTime: 0,
                    finished: false,
                    // ì•„ì´í…œ ìƒíƒœ
                    stunned: false,
                    stunTime: 0,
                    boosted: false,
                    boostTime: 0,
                    boostTime: 0,
                    trackItems: [], // íŠ¸ë™ ìœ„ ì•„ì´í…œ ëª©ë¡
                    // ì†ë„ë¥¼ ëŒ€í­ ë‚®ì¶¤ (0.01 ~ 0.03)
                    speedFactor: 0.01 + Math.random() * 0.02
                });
            }

            // í™”ë©´ ì „í™˜
            document.getElementById('naming-screen').classList.add('hidden');
            document.getElementById('race-screen').classList.remove('hidden');
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('reset-btn').classList.add('hidden');

            // ì„¤ì • í™•ì¸
            isItemMode = document.getElementById('item-mode-toggle').checked;

            // ì•„ì´í…œ ëª¨ë“œì¼ ê²½ìš° ì•„ì´í…œ ìƒì„±
            if (isItemMode) {
                players.forEach(p => {
                    p.trackItems = generateTrackItems();
                });
            }

            // íŠ¸ë™ ìƒì„±
            renderTrack();

            // ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì‹œì‘
            addCommentary("ì ì‹œ í›„ ê²½ê¸°ê°€ ì‹œì‘ë©ë‹ˆë‹¤!");
            let count = 3;
            document.getElementById('game-status').innerText = "ì¶œë°œ ì¤€ë¹„...";

            const countInterval = setInterval(() => {
                if (count > 0) {
                    addCommentary(`${count}...!`);
                    document.getElementById('game-status').innerText = `COUNTDOWN: ${count}`;
                    count--;
                } else {
                    clearInterval(countInterval);
                    addCommentary("ì¶œë°œí–ˆìŠµë‹ˆë‹¤!!! ğŸ");
                    document.getElementById('game-status').innerText = "RACE START!";
                    isRacing = true;
                    startTime = Date.now(); // ì‹œê°„ ì¸¡ì • ì‹œì‘
                    requestAnimationFrame(gameLoop);
                    commentaryTimer = setInterval(randomCommentary, 2000); // ë©˜íŠ¸ ê°„ê²©ë„ ì¡°ê¸ˆ ëŠ˜ë¦¼
                }
            }, 800);
        }

        function renderTrack() {
            const track = document.getElementById('track');
            track.innerHTML = '<div class="finish-line"></div>';

            players.forEach((p, idx) => {
                const lane = document.createElement('div');
                lane.className = 'lane pl-2';
                if (idx % 2 === 0) lane.style.backgroundColor = 'rgba(0,0,0,0.05)';

                // ì•„ì´í…œ ë Œë”ë§
                let itemsHtml = '';
                if (isItemMode && p.trackItems) {
                    p.trackItems.forEach((item, itemIdx) => {
                        const icon = item.type === 'BANANA' ? 'ğŸŒ' : 'ğŸš€';
                        itemsHtml += `<div id="item-${p.id}-${itemIdx}" class="track-item" style="left: ${item.pos}%;">${icon}</div>`;
                    });
                }

                lane.innerHTML = `
                    ${itemsHtml}
                    <div id="horse-${idx}" class="horse">
                        <div id="horse-sprite-${idx}" class="horse-sprite text-4xl relative">
                            ${horseSvg(p.color)}
                            <div id="status-icon-${idx}" class="absolute -top-4 left-2 text-lg"></div>
                        </div>
                        <div class="text-[10px] mt-1 whitespace-nowrap overflow-hidden text-ellipsis w-24 bg-black bg-opacity-50 px-1 rounded absolute -bottom-4 left-0 text-white border border-black">${p.name}</div>
                        <div id="dust-${idx}" class="dust"></div>
                    </div>
                `;
                track.appendChild(lane);
            });
        }

        function generateTrackItems() {
            const items = [];
            // ë ˆì¸ ë‹¹ 2~4ê°œ ì•„ì´í…œ ìƒì„±
            const count = 2 + Math.floor(Math.random() * 3);

            for (let i = 0; i < count; i++) {
                // ìœ„ì¹˜: 10% ~ 80% ì‚¬ì´ ëœë¤ (ì¶œë°œ/ë„ì°© ì§€ì  ì œì™¸)
                const pos = 10 + Math.random() * 70;
                // íƒ€ì…: 60% ë°”ë‚˜ë‚˜, 40% ë¶€ìŠ¤í„°
                const type = Math.random() < 0.6 ? 'BANANA' : 'BOOSTER';
                items.push({ pos, type, hit: false });
            }
            // ìœ„ì¹˜ ìˆœ ì •ë ¬
            return items.sort((a, b) => a.pos - b.pos);
        }

        function gameLoop() {
            if (!isRacing) return;

            let finishedCount = players.filter(p => p.finished).length;
            let stillRacing = false;

            // --- ê¸´ì¥ê° í–¥ìƒ: í˜„ì¬ ìˆœìœ„ ê³„ì‚° ---
            const activePlayers = players.filter(p => !p.finished);
            const sortedByPos = [...activePlayers].sort((a, b) => b.pos - a.pos);
            const leader = sortedByPos[0];
            const trailer = sortedByPos[sortedByPos.length - 1];

            // --- ì„ ë‘ ì—­ì „ ê°ì§€ ---
            if (leader && lastLeaderId !== null && lastLeaderId !== leader.id) {
                leadChangeCount++;
                addCommentary(`ğŸ”„ ì—­ì „! [${leader.name}]ì´(ê°€) ì„ ë‘ë¡œ ì¹˜ê³  ë‚˜ê°‘ë‹ˆë‹¤!`);
            }
            if (leader) lastLeaderId = leader.id;

            // --- ìŠ¬ë¡œìš°ëª¨ì…˜: ì„ ë‘ê°€ 80% ì´ìƒì¼ ë•Œ í™œì„±í™” ---
            if (leader && leader.pos >= trackLength * 0.85 && !isSlowMotion) {
                isSlowMotion = true;
                document.getElementById('track').classList.add('slowmo');
                document.querySelector('.finish-line').classList.add('finish-glow');
                addCommentary(`âš¡ ê²°ìŠ¹ì„ ì´ ì½”ì•ì…ë‹ˆë‹¤! ê¸´ì¥ê°ì´ ìµœê³ ì¡°!`);
            }

            // --- ëŒí’ ì´ë²¤íŠ¸ ë¹„í™œì„±í™” ---
            // (ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì œê±°ë¨)

            players.forEach((p, idx) => {
                if (p.finished) return;

                stillRacing = true;

                // ì•„ì´í…œ ë¡œì§ (ìŠ¤í„´ ìƒíƒœë©´ ì´ë™ ë¶ˆê°€)
                if (p.stunned) {
                    p.stunTime--;
                    if (p.stunTime <= 0) {
                        p.stunned = false;
                        updateStatusIcon(p.id, '');
                        document.getElementById(`horse-sprite-${p.id}`).classList.remove('stun-effect');
                    }
                    return; // ì´ë™ ê±´ë„ˆëœ€
                }

                // --- ê¸°ë³¸ ì†ë„ ê³„ì‚° (ëœë¤ í­ ì¦ê°€: 0 ~ 0.08) ---
                let move = (Math.random() * 0.08) + p.speedFactor;

                // --- ëŸ¬ë²„ë°´ë”©: ìˆœìœ„ ê¸°ë°˜ ì†ë„ ë³´ì • ---
                const currentRank = sortedByPos.findIndex(sp => sp.id === p.id) + 1;
                const totalActive = sortedByPos.length;

                if (totalActive > 1) {
                    // ê¼´ì°Œì—ê²Œ +30% ë³´ë„ˆìŠ¤, ì„ ë‘ì—ê²Œ -10% íŒ¨ë„í‹°
                    const rankRatio = (currentRank - 1) / (totalActive - 1); // 0(ì„ ë‘) ~ 1(ê¼´ì°Œ)
                    const rubberBandFactor = 0.9 + (rankRatio * 0.4); // 0.9 ~ 1.3
                    move *= rubberBandFactor;
                }

                // --- í›„ë°˜ë¶€: 70% ì´í›„ ëŠë ¤ì§€ë©´ì„œ ë³€ë™ì„± í­ë°œ ---
                if (p.pos >= trackLength * 0.7) {
                    // í›„ë°˜ë¶€ ê¸°ë³¸ ì†ë„ 50% ê°ì†Œ
                    move *= 0.5;

                    // í° ê°€ì† (10% í™•ë¥ , 6~12ë°° í­ë°œì  ê°€ì†)
                    if (Math.random() < 0.10) {
                        move *= 6 + Math.random() * 6;
                        showDust(p.id);
                        if (Math.random() < 0.3) {
                            addCommentary(`ğŸ’¨ [${p.name}] ë§‰íŒ ìŠ¤í¼íŠ¸!`);
                        }
                    }

                    // í° ê°ì† (8% í™•ë¥ , ê±°ì˜ ë©ˆì¶¤)
                    if (Math.random() < 0.08) {
                        move *= 0.1;
                        if (Math.random() < 0.3) {
                            addCommentary(`ğŸ˜° [${p.name}] ì²´ë ¥ì´ ë°”ë‹¥ë‚¬ë‚˜?!`);
                        }
                    }
                }

                // --- ìŠ¬ë¡œìš°ëª¨ì…˜ íš¨ê³¼: ì†ë„ 50% ê°ì†Œ ---
                if (isSlowMotion) {
                    move *= 0.5;
                }

                // ë¶€ìŠ¤í„° ìƒíƒœ
                if (p.boosted) {
                    move *= 3.0;
                    p.boostTime--;
                    if (p.boostTime <= 0) {
                        p.boosted = false;
                        updateStatusIcon(p.id, '');
                        document.getElementById(`horse-sprite-${p.id}`).classList.remove('boost-effect');
                    }
                }

                // ì•„ì´í…œ ëª¨ë“œ: ì¶©ëŒ ì²´í¬
                if (isItemMode && !p.stunned) {
                    if (p.trackItems) {
                        p.trackItems.forEach((item, itemIdx) => {
                            if (!item.hit && p.pos >= item.pos) {
                                item.hit = true;
                                const itemEl = document.getElementById(`item-${p.id}-${itemIdx}`);
                                if (itemEl) itemEl.classList.add('hit');

                                if (item.type === 'BANANA') {
                                    if (p.boosted) {
                                        addCommentary(`ğŸŒ [${p.name}] ë¶€ìŠ¤í„°ë¡œ ë°”ë‚˜ë‚˜ ëŒíŒŒ!`);
                                    } else {
                                        triggerBanana(p);
                                    }
                                } else if (item.type === 'BOOSTER') {
                                    triggerBooster(p);
                                }
                            }
                        });
                    }
                }

                // ê¸°ì¡´ ëœë¤ ê°€ì†/ë¹„í‹€ê±°ë¦¼ (í›„ë°˜ë¶€ê°€ ì•„ë‹ ë•Œë§Œ)
                if (p.pos < trackLength * 0.7) {
                    if (!p.boosted && Math.random() < 0.03) {
                        move *= 4;
                        showDust(p.id);
                    }
                    if (!p.boosted && Math.random() < 0.01) move = -0.05;
                }

                p.pos += move;

                // í”¼ë‹ˆì‹œ ì²´í¬
                if (p.pos >= trackLength) {
                    p.pos = trackLength;
                    p.finished = true;
                    p.rank = finishedCount + 1;
                    p.finishTime = ((Date.now() - startTime) / 1000).toFixed(2);
                    photoFinishCandidates.push({ ...p, finishMs: Date.now() });
                    addCommentary(`ğŸš© [${p.name}] ${p.finishTime}ì´ˆ ê¸°ë¡ìœ¼ë¡œ ê³¨ì¸!`);
                    finishedCount++;
                }

                // UI ì—…ë°ì´íŠ¸
                const horseEl = document.getElementById(`horse-${p.id}`);
                horseEl.style.left = `${p.pos}%`;
                horseEl.style.zIndex = Math.floor(p.pos);
            });

            // --- ë§‰íŒ ì¶”ê²© ë©˜íŠ¸ ---
            if (leader && trailer && !isSlowMotion) {
                const gap = leader.pos - trailer.pos;
                if (gap < 5 && leader.pos > 50 && Math.random() < 0.02) {
                    addCommentary(`ğŸ”¥ [${trailer.name}] ë§¹ë ¬íˆ ì¶”ê²© ì¤‘! ì°¨ì´ê°€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤!`);
                }
            }

            if (!stillRacing) {
                endRace();
            } else {
                requestAnimationFrame(gameLoop);
            }
        }

        function triggerBanana(p) {
            p.stunned = true;
            p.stunTime = 90; // ì•½ 1.5ì´ˆ (60fps ê¸°ì¤€)
            updateStatusIcon(p.id, 'ğŸŒ');
            document.getElementById(`horse-sprite-${p.id}`).classList.add('stun-effect');
            addCommentary(`ğŸŒ [${p.name}] ë°”ë‚˜ë‚˜ë¥¼ ë°Ÿê³  ë¯¸ë„ëŸ¬ì¡ŒìŠµë‹ˆë‹¤!`);
        }

        function triggerBooster(p) {
            p.boosted = true;
            p.boostTime = 60; // ì•½ 1ì´ˆ
            updateStatusIcon(p.id, 'ğŸš€');
            document.getElementById(`horse-sprite-${p.id}`).classList.add('boost-effect');
            addCommentary(`ğŸš€ [${p.name}] ë¶€ìŠ¤í„° ë°œë™! ì—„ì²­ë‚œ ì†ë„!`);
            showDust(p.id);
        }

        function updateStatusIcon(id, icon) {
            document.getElementById(`status-icon-${id}`).innerText = icon;
        }

        function showDust(id) {
            const dust = document.getElementById(`dust-${id}`);
            dust.classList.remove('active');
            void dust.offsetWidth;
            dust.classList.add('active');
        }

        // --- ê¸´ì¥ê° í–¥ìƒ: ëŒí’ ì´ë²¤íŠ¸ ---
        function triggerWindEvent() {
            windEventTriggered = true;

            // í™”ë©´ í”ë“¤ë¦¼
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 800);

            // ë°”ëŒ ì˜¤ë²„ë ˆì´ íš¨ê³¼
            const windOverlay = document.createElement('div');
            windOverlay.className = 'wind-overlay';
            document.body.appendChild(windOverlay);
            setTimeout(() => windOverlay.remove(), 1000);

            // ëª¨ë“  í™œì„± í”Œë ˆì´ì–´ ìœ„ì¹˜ Â±15% ëœë¤ ë³€ë™
            players.forEach(p => {
                if (!p.finished && !p.stunned) {
                    const shift = (Math.random() - 0.5) * 30; // -15 ~ +15
                    p.pos = Math.max(5, Math.min(trackLength - 10, p.pos + shift));
                }
            });

            addCommentary(`ğŸŒªï¸ ëŒí’ ë°œìƒ! ëª¨ë“  ì„ ìˆ˜ì˜ ìœ„ì¹˜ê°€ ë’¤ì„ì…ë‹ˆë‹¤!`);
        }

        // --- ê¸´ì¥ê° í–¥ìƒ: ì‚¬ì§„ íŒì • í‘œì‹œ ---
        function showPhotoFinish() {
            const popup = document.createElement('div');
            popup.className = 'photo-finish-popup';
            popup.innerHTML = `
                <div style="font-size: 24px; font-weight: bold; text-align: center;">
                    ğŸ“¸ PHOTO FINISH!<br>
                    <span style="font-size: 14px;">ì‚¬ì§„ íŒì • ì§„í–‰ ì¤‘...</span>
                </div>
            `;
            document.body.appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        // --- ê¸´ì¥ê° í–¥ìƒ: ìƒíƒœ ì´ˆê¸°í™” ---
        function resetTensionState() {
            isSlowMotion = false;
            windEventTriggered = false;
            lastLeaderId = null;
            leadChangeCount = 0;
            photoFinishCandidates = [];

            // CSS í´ë˜ìŠ¤ ì œê±°
            const track = document.getElementById('track');
            if (track) track.classList.remove('slowmo');
            const finishLine = document.querySelector('.finish-line');
            if (finishLine) finishLine.classList.remove('finish-glow');
        }

        function endRace() {
            isRacing = false;
            clearInterval(commentaryTimer);
            document.getElementById('game-status').innerText = "ê²½ê¸° ì¢…ë£Œ";

            // --- ì‚¬ì§„ íŒì • ì²´í¬ ---
            if (photoFinishCandidates.length >= 2) {
                const first = photoFinishCandidates[0];
                const second = photoFinishCandidates[1];
                const timeDiff = Math.abs(first.finishMs - second.finishMs);

                if (timeDiff < 100) { // 0.1ì´ˆ ì´ë‚´ ë™ì‹œ ë„ì°©
                    showPhotoFinish();
                    addCommentary(`ğŸ“¸ ì‚¬ì§„ íŒì •! ${first.name}ì™€ ${second.name}ì˜ ì´ˆë°•ë¹™ ìŠ¹ë¶€!`);
                }
            }

            // --- ì—­ì „ íšŸìˆ˜ ë©˜íŠ¸ ---
            if (leadChangeCount > 3) {
                addCommentary(`ğŸ”¥ ì´ë²ˆ ê²½ê¸°ì—ì„œ ë¬´ë ¤ ${leadChangeCount}ë²ˆì˜ ì—­ì „ì´ ìˆì—ˆìŠµë‹ˆë‹¤!`);
            }

            addCommentary("ëª¨ë“  ì„ ìˆ˜ê°€ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤! ê²°ê³¼ë¥¼ ì§‘ê³„í•©ë‹ˆë‹¤...");

            // ê²°ê³¼ ì •ë ¬
            const ranks = players.sort((a, b) => a.rank - b.rank);
            const loser = ranks[ranks.length - 1];

            setTimeout(() => {
                // 1. ê¼´ì°Œ í‘œì‹œ
                document.getElementById('loser-name').innerText = loser.name;
                document.getElementById('loser-time').innerText = `ê¸°ë¡: ${loser.finishTime}s`;

                // 2. ì „ì²´ ë­í‚¹ ë¦¬ìŠ¤íŠ¸ ìƒì„±
                const listContainer = document.getElementById('ranking-list');
                listContainer.innerHTML = '';

                ranks.forEach((p) => {
                    const item = document.createElement('div');
                    item.className = 'rank-item';

                    // 1,2,3ë“± ë±ƒì§€ ì²˜ë¦¬
                    let badge = `<span class="font-bold text-gray-500">${p.rank}</span>`;
                    if (p.rank === 1) badge = 'ğŸ¥‡';
                    if (p.rank === 2) badge = 'ğŸ¥ˆ';
                    if (p.rank === 3) badge = 'ğŸ¥‰';

                    // ê¼´ì°Œ í‘œì‹œ
                    let nameStyle = "";
                    if (p.rank === players.length) {
                        badge = 'ğŸ’€';
                        nameStyle = "text-red-600 font-bold decoration-wavy underline";
                    }

                    item.innerHTML = `
                        <div class="flex items-center">
                            <span class="rank-badge text-xl">${badge}</span>
                            <div class="flex flex-col">
                                <span class="${nameStyle}">${p.name}</span>
                            </div>
                        </div>
                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">${p.finishTime}s</span>
                    `;
                    listContainer.appendChild(item);
                });

                document.getElementById('result-modal').classList.remove('hidden');
                document.getElementById('reset-btn').classList.remove('hidden');

                // ìŠ¬ë¡œìš°ëª¨ì…˜ íš¨ê³¼ ì œê±°
                resetTensionState();
            }, 1500);
        }

        // --- ì¤‘ê³„ ì‹œìŠ¤í…œ ---
        const comments = [
            "ì¹˜ì—´í•œ ì ‘ì „ì…ë‹ˆë‹¤!",
            "ì„ ë‘ê°€ ê³„ì† ë°”ë€Œê³  ìˆìŠµë‹ˆë‹¤!",
            "ë¨¼ì§€ê°€ íœ˜ë‚ ë¦½ë‹ˆë‹¤!",
            "ì»¤í”¼ëŠ” ëˆ„ê°€ ì‚¬ê²Œ ë ê¹Œìš”?",
            "ì•„ì§ ê²°ê³¼ëŠ” ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!",
            "ë§‰íŒ ìŠ¤í¼íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤!",
            "ë¹„í‹€ê±°ë¦¬ëŠ” ì„ ìˆ˜ê°€ ë³´ì…ë‹ˆë‹¤!",
            "ì—„ì²­ë‚œ ì§€êµ¬ë ¥ì…ë‹ˆë‹¤!",
            "ì‹¬ì¥ì´ í„°ì§ˆ ê²ƒ ê°™ì€ ìˆœê°„!",
            "ìˆ¨ ë§‰íˆëŠ” ë ˆì´ìŠ¤!",
            "ì—­ì „ì˜ ê¸°íšŒê°€ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤!",
            "ì´ˆë°•ë¹™ ìŠ¹ë¶€! ëˆ„ê°€ ì´ê¸¸ê¹Œìš”?",
            "ê²°ìŠ¹ì„ ì´ ì ì  ê°€ê¹Œì›Œì§‘ë‹ˆë‹¤!",
            "í•œ ìˆœê°„ë„ ë°©ì‹¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!",
            "ì´ê±´ ì—­ëŒ€ê¸‰ ë ˆì´ìŠ¤ì…ë‹ˆë‹¤!"
        ];

        function addCommentary(text) {
            const box = document.getElementById('commentary-box');
            box.innerHTML = `> ${text}<br>` + box.innerHTML;
        }

        function randomCommentary() {
            if (!isRacing) return;

            const leader = players.reduce((prev, current) => (prev.pos > current.pos) ? prev : current);
            const laster = players.reduce((prev, current) => (prev.pos < current.pos) ? prev : current);

            const r = Math.random();
            if (r < 0.25) {
                addCommentary(`ğŸ”¥ [${leader.name}] ì„ ë‘ ìœ ì§€!`);
            } else if (r < 0.5) {
                addCommentary(`ğŸ’¦ [${laster.name}] í˜ì„ ë‚´ì•¼ í•©ë‹ˆë‹¤!`);
            } else {
                addCommentary(comments[Math.floor(Math.random() * comments.length)]);
            }
        }

        function resetGame() {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('race-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            isRacing = false;

            // ê¸´ì¥ê° ìƒíƒœ ì´ˆê¸°í™”
            resetTensionState();
        }
    </script>
</body>

</html>